<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot HPTTS - Tư vấn tuyển sinh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện Markdown để hiển thị định dạng văn bản từ AI -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chatbot-messages::-webkit-scrollbar { width: 6px; }
        .chatbot-messages::-webkit-scrollbar-track { background: transparent; }
        .chatbot-messages::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 3px; }
        .chatbot-messages::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .message-enter { opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .message-enter-active { opacity: 1; transform: translateY(0); }
        /* Carousel Styles */
        .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 12px; padding-bottom: 12px; }
        .carousel-item { scroll-snap-align: start; flex: 0 0 280px; }
        .carousel::-webkit-scrollbar { height: 8px; }
        .carousel::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        /* CSS cho Markdown */
        .markdown-content p { margin-bottom: 0.5rem; }
        .markdown-content ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.5rem; }
        .markdown-content strong { font-weight: 700; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="chatbot-container" class="flex flex-col h-screen max-h-screen bg-cover bg-center text-gray-800" style="background-image: url('https://i.postimg.cc/htHNRcqW/a2aa61fe-c3e9-4944-91cb-0ab480de88f3.png')">
        
        <header class="flex-shrink-0 bg-blue-600/90 backdrop-blur-sm text-white p-3 flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-3">
                <img src="https://i.postimg.cc/76yv0DBM/1d4b55a2-0860-49cf-b4e7-f5fb3554e7da.jpg" alt="HPTTS Logo" class="w-10 h-10 rounded-full object-cover border-2 border-white/50">
                <div>
                    <h1 class="text-base font-bold">Chatbot HPTTS</h1>
                    <p class="text-xs text-blue-100">Tư vấn tuyển sinh</p>
                </div>
            </div>
            <button id="reset-button" class="p-2 rounded-full hover:bg-blue-700/50 transition-colors" aria-label="Bắt đầu lại cuộc trò chuyện">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 11A8.1 8.1 0 0 0 4.5 9M4 5v4h4"/><path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"/></svg>
            </button>
        </header>

        <main id="chat-area" class="flex-grow p-4 overflow-y-auto chatbot-messages">
            <div id="message-container" class="max-w-3xl mx-auto w-full space-y-6">
                <!-- Messages will be dynamically inserted here -->
            </div>
        </main>

        <footer class="flex-shrink-0 bg-white/80 backdrop-blur-sm border-t border-gray-200/50 p-3">
            <div class="max-w-3xl mx-auto w-full">
                <form id="chat-form" class="flex items-center gap-2">
                    <input id="chat-input" type="text" placeholder="Nhập câu hỏi..." class="w-full px-4 py-2.5 bg-gray-100 rounded-full border-2 border-transparent focus:outline-none focus:border-blue-500 transition-colors text-sm" autocomplete="off">
                    <button id="send-button" type="submit" class="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 disabled:bg-gray-300 transition-colors flex-shrink-0" aria-label="Gửi tin nhắn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
                <p class="text-center text-xs text-gray-600 mt-2">&copy; 2025 HPTTS</p>
            </div>
        </footer>
    </div>

    <script type="module">
        // --- Gemini API Integration ---
        const API_KEY = process.env.GEMINI_API_KEY; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        // --- DOM Elements ---
        const chatArea = document.getElementById('chat-area');
        const messageContainer = document.getElementById('message-container');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const resetButton = document.getElementById('reset-button');

        // --- Constants & Data ---
        const HPTTS_LOGO_URL = 'https://i.postimg.cc/76yv0DBM/1d4b55a2-0860-49cf-b4e7-f5fb3554e7da.jpg';
        const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx1NOYgn-93fU2oINV9TFxZA1x9X89u_KGr994bfWcKSzCFdEWMh4WQM9YmYZZims5g/exec';
        
        // --- State Management ---
        let chatHistory = [];
        let isLoading = false;
        let registrationStep = 'idle';
        let registrationData = {};

        // --- Data from uploaded files ---
        const courseList = {
            "SC01": { name: "Vận hành cần trục giàn QC, STS", fee: "25.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá, quy trình và an toàn lao động: Cung cấp kiến thức nền tảng về hàng container, quy trình xếp dỡ tại cầu tàu và các tiêu chuẩn an toàn lao động nghiêm ngặt.\n- Mô đun 2 - Cấu tạo và nguyên lý vận hành cần trục QC: Trang bị kiến thức chuyên sâu về cấu tạo, nguyên lý hoạt động của các hệ thống cơ, điện và thiết bị an toàn trên cần trục QC.\n- Mô đun 3 - Thực hành vận hành cần trục QC: Học viên được trực tiếp thực hành trên thiết bị, từ các thao tác cơ bản không tải đến vận hành xếp dỡ container trong một chu trình làm việc thực tế.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành thành thạo, chính xác cần trục giàn QC để xếp dỡ container từ tàu lên bờ và ngược lại, đáp ứng yêu cầu cao của các cảng container hiện đại.\n- Nắm vững cấu tạo thiết bị để thực hiện kiểm tra an toàn đầu ca, phối hợp xử lý các sự cố kỹ thuật cơ bản.\n- Tự tin ứng tuyển vào vị trí công nhân vận hành cần trục giàn QC, một trong những vị trí có vai trò và thu nhập tốt tại các cảng biển lớn." },
            "SC02": { name: "Vận hành cần trục giàn RTG", fee: "20.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá, quy trình và an toàn lao động: Trang bị kiến thức về hàng container, quy trình xếp dỡ tại bãi và các quy định an toàn khi làm việc với cần trục RTG.\n- Mô đun 2 - Cấu tạo và nguyên lý vận hành RTG: Tìm hiểu chi tiết về hệ thống cơ, điện, các cơ cấu làm việc và thiết bị an toàn của cần trục RTG.\n- Mô đun 3 - Thực hành vận hành RTG: Rèn luyện kỹ năng vận hành thực tế tại bãi, từ các thao tác cơ bản đến việc nâng hạ, di chuyển và xếp container theo các phương án khác nhau.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành chuyên nghiệp cần trục giàn RTG để xếp dỡ và quản lý container tại bãi một cách hiệu quả, chính xác.\n- Thực hiện thành thạo công tác kiểm tra, bảo dưỡng thiết bị hàng ngày để đảm bảo an toàn và hiệu suất làm việc.\n- Đảm nhận vị trí công nhân vận hành RTG tại các cảng container và trung tâm logistics." },
            "SC03": { name: "Vận hành cần trục chân đế", fee: "15.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá, quy trình và an toàn lao động: Cung cấp kiến thức tổng quan về các loại hàng hóa (hàng bao, kiện, sắt thép, container), quy trình xếp dỡ và an toàn lao động tại cảng.\n- Mô đun 2 - Cấu tạo và nguyên lý vận hành: Phân tích sâu về cấu tạo, nguyên lý hoạt động của các hệ thống cơ, điện và các thiết bị an toàn trên các loại cần trục chân đế phổ biến (Kirov, Tukan...).\n- Mô đun 3 - Thực hành vận hành cần trục chân đế: Trực tiếp thực hành vận hành cần trục từ cơ bản đến nâng cao, xếp dỡ các loại hàng hóa thực tế và xử lý tình huống tại hiện trường.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành thành thạo các loại cần trục chân đế để xếp dỡ đa dạng các loại hàng hóa một cách an toàn và năng suất.\n- Nắm vững kỹ thuật, thực hiện kiểm tra an toàn thiết bị và phối hợp xử lý các sự cố thường gặp.\n- Tự tin làm việc tại các cảng tổng hợp, có cơ hội phát triển lên các vị trí tổ trưởng, tổ phó." },
            "SC04": { name: "Vận hành xe nâng hàng Container (Reach Stacker - RS)", fee: "15.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá và an toàn lao động: Cung cấp kiến thức về các loại hàng hóa, container và các quy tắc an toàn khi vận hành xe nâng hạng nặng.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển xe nâng hàng Container: Nghiên cứu sâu về động cơ, hệ thống thủy lực, hệ thống điện và nguyên lý điều khiển của xe Reachstacker.\n- Mô đun 3 - Vận hành xe nâng hàng container: Rèn luyện kỹ năng thực tế từ các thao tác cơ bản đến việc nâng hạ, di chuyển và sắp xếp container 20', 40' tại bãi.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành thành thạo xe nâng Reachstacker để xếp dỡ, di chuyển container một cách chính xác, linh hoạt và an toàn.\n- Thực hiện công tác kiểm tra, bảo dưỡng xe hàng ngày, đảm bảo xe luôn trong tình trạng kỹ thuật tốt nhất.\n- Trở thành công nhân vận hành có tay nghề cao, làm việc tại các cảng container, ICD, và các trung tâm logistics lớn." },
            "SC05": { name: "Vận hành xe nâng hàng Forklift (xe nâng càng)", fee: "6.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá và an toàn lao động: Trang bị kiến thức về các loại hàng hóa thông thường, cách xếp dỡ và các quy định an toàn khi vận hành xe nâng.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển xe nâng hàng Forklift: Tìm hiểu về cấu tạo động cơ, hệ thống thủy lực, hệ thống điện và kỹ thuật điều khiển các loại xe nâng forklift.\n- Mô đun 3 - Thực hành vận hành xe nâng hàng Forklift: Thực hành các kỹ năng vận hành xe trong nhiều không gian khác nhau (kho, bãi, hầm tàu) và kỹ năng chuyên biệt như đóng/rút hàng trong container.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành linh hoạt, an toàn các loại xe nâng forklift để xếp dỡ hàng hóa đa dạng tại kho, bãi, nhà xưởng.\n- Nắm vững kỹ thuật để kiểm tra và bảo dưỡng xe, đảm bảo an toàn cho bản thân, hàng hóa và thiết bị.\n- Dễ dàng tìm kiếm việc làm tại hầu hết các doanh nghiệp có hoạt động sản xuất, kho bãi, logistics." },
            "SC06": { name: "Vận hành cổng trục, cầu trục", fee: "5.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá và an toàn lao động: Cung cấp kiến thức về các loại hàng hóa thường xếp dỡ bằng cầu trục (sắt thép, thiết bị nặng) và các quy tắc an toàn trong nhà xưởng, kho bãi.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển cầu trục, cổng trục: Tìm hiểu chi tiết về hệ thống cơ, điện, các cơ cấu làm việc (nâng hạ, di chuyển xe con, di chuyển cổng) và thiết bị an toàn.\n- Mô đun 3 - Thực hành vận hành cầu trục, cổng trục: Rèn luyện kỹ năng điều khiển cầu trục/cổng trục để nâng hạ và di chuyển hàng hóa một cách chính xác, nhịp nhàng.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành an toàn, hiệu quả các loại cầu trục, cổng trục trong các nhà xưởng, kho bãi để xếp dỡ hàng hóa.\n- Nắm vững quy trình kiểm tra, bảo dưỡng thiết bị hàng ngày, đảm bảo an toàn tuyệt đối trong sản xuất.\n- Làm việc tại các cảng, nhà máy công nghiệp nặng, xí nghiệp sản xuất, các đơn vị có hệ thống kho bãi lớn." },
            "SC07": { name: "Vận hành cần trục tàu thủy", fee: "7.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá, quy trình và An toàn lao động: Trang bị kiến thức về các loại hàng hóa, phương pháp xếp dỡ và các quy định an toàn đặc thù khi làm việc trên tàu.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển cần trục tầu thủy: Tìm hiểu về các loại cần trục tàu, cấu tạo các cơ cấu và kỹ thuật điều khiển, hệ thống tín hiệu chuyên dụng.\n- Mô đun 3 - Vận hành cần trục tàu thủy: Thực hành trực tiếp các thao tác vận hành trên cần trục tàu, xếp dỡ hàng hóa trong các điều kiện làm việc thực tế.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành an toàn và hiệu quả các loại cần trục được trang bị trên tàu thủy để xếp dỡ hàng hóa tại cảng hoặc chuyển tải.\n- Hiểu rõ các thông số kỹ thuật, quy trình kiểm tra an toàn và phối hợp nhịp nhàng với đội ngũ làm hàng trên bờ và dưới hầm tàu.\n- Làm việc tại các công ty vận tải biển, công ty dịch vụ hàng hải, hoặc các cảng có hoạt động xếp dỡ sang mạn." },
            "SC08": { name: "Vận hành xe xúc gạt", fee: "8.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá, quy trình và an toàn lao động: Tìm hiểu về đặc tính các loại hàng rời (than, quặng, gỗ dăm...) và các quy trình, quy định an toàn khi làm việc.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển xe xúc, gạt: Nghiên cứu về cấu tạo, nguyên lý hoạt động của động cơ, hệ thống thủy lực, hệ thống điện và kỹ thuật điều khiển xe.\n- Mô đun 3 - Thực hành vận hành xe xúc, gạt: Trực tiếp thực hành các thao tác xúc, gạt, san ủi các loại hàng rời tại bãi và trong hầm tàu.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành chuyên nghiệp xe xúc gạt để gom hàng, san gạt, làm sạch hầm tàu và kho bãi, góp phần tăng năng suất xếp dỡ.\n- Nắm vững kỹ thuật để kiểm tra, bảo dưỡng xe, đảm bảo thiết bị hoạt động ổn định và an toàn.\n- Làm việc tại các cảng hàng rời, công ty khai khoáng, nhà máy sản xuất có kho chứa nguyên liệu lớn." },
            "SC09": { name: "Nghiệp vụ giao nhận hàng hóa (Sơ cấp)", fee: "6.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Nghiệp vụ giao nhận hàng hoá: Cung cấp kiến thức toàn diện về quy trình, thủ tục giao nhận hàng bách hóa và hàng container với tàu, tại kho, bãi, cổng cảng.\n- Mô đun 2 - Nghiệp vụ kết toán hàng hoá: Trang bị kỹ năng chuyên sâu về việc lập biên bản, kết toán hàng hóa với tàu, đặc biệt là các thuật ngữ tiếng Anh chuyên ngành và cách xử lý hàng hóa tổn thất.\n- Mô đun 3 - Thực hành giao nhận hàng hoá: Trực tiếp thực hành công việc của một nhân viên giao nhận tại các vị trí thực tế (cầu tàu, kho bãi, cổng), sử dụng các phần mềm và thiết bị cầm tay (HHC) chuyên dụng.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Thực hiện thành thạo các nghiệp vụ giao nhận, kiểm đếm, lập chứng từ cho tất cả các loại hàng hóa tại cảng.\n- Sử dụng hiệu quả các hệ thống phần mềm quản lý cảng (PL-TOS, Smart Gate) và thiết bị công nghệ để hoàn thành công việc.\n- Trở thành nhân viên giao nhận chuyên nghiệp, có thể làm việc tại các cảng, các công ty logistics, hãng tàu, công ty xuất nhập khẩu." },
            "SC10": { name: "Vận hành cần trục bánh lốp, bánh xích", fee: "8.000.000 VNĐ", duration: "3 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàng hoá và an toàn lao động: Cung cấp kiến thức về các loại hàng hóa phổ biến và các nguyên tắc an toàn khi làm việc với cần trục di động.\n- Mô đun 2 - Kết cấu và kỹ thuật điều khiển cần trục bánh lốp: Tìm hiểu chuyên sâu về động cơ, hệ thống thủy lực, hệ thống điện và kỹ thuật điều khiển cần trục bánh lốp, bánh xích.\n- Mô đun 3 - Thực hành vận hành cần trục bánh lốp: Rèn luyện kỹ năng vận hành thực tế, từ việc di chuyển, ra chân chống, đến nâng hạ các loại hàng hóa khác nhau.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Vận hành thành thạo các loại cần trục bánh lốp, bánh xích để xếp dỡ hàng hóa một cách linh hoạt tại cảng, kho bãi và các công trường xây dựng.\n- Hiểu rõ nguyên lý hoạt động để thực hiện công tác kiểm tra, bảo dưỡng cơ bản và vận hành an toàn.\n- Đáp ứng nhu cầu nhân lực cho các cảng biển, công ty xây dựng và các dự án lớn." },
            "SC11": { name: "Hàn và cắt kim loại", fee: "12.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Hàn hồ quang tay: Cung cấp kiến thức nền tảng về vật liệu hàn, cách chuẩn bị mối hàn , kỹ thuật hàn hồ quang tay (hàn que) cơ bản và các quy tắc an toàn lao động trong ngành hàn.\n- Mô đun 2 - Hàn TIG và MIG/MAG: Giới thiệu các công nghệ hàn hiện đại, đi sâu vào nguyên lý , cấu tạo máy, vật liệu và kỹ thuật hàn TIG (hàn inox, nhôm) và hàn MIG/MAG (hàn CO2).\n- Mô đun 3 - Thực hành hàn và cắt: Tập trung rèn luyện tay nghề, học viên được trực tiếp thực hành cả 3 phương pháp hàn (que, TIG, MIG) trên các loại vật liệu và ở nhiều vị trí hàn khác nhau, từ cơ bản đến phức tạp.", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Thực hiện thành thạo các kỹ thuật hàn hồ quang tay (hàn que), hàn TIG, hàn MIG/MAG trên các vật liệu kim loại khác nhau và ở nhiều vị trí hàn (hàn bằng, hàn ngang, hàn đứng).\n- Đọc và hiểu được các ký hiệu mối hàn trên bản vẽ kỹ thuật, tự tin lựa chọn vật liệu, chuẩn bị phôi và thiết lập chế độ hàn phù hợp.\n- Tự tin ứng tuyển vào vị trí thợ hàn tại các xưởng cơ khí, công ty xây dựng, nhà máy sản xuất, đơn vị sửa chữa tàu thuyền và các doanh nghiệp gia công kết cấu thép." },
            "SC12": { name: "Sửa chữa ô tô", fee: "12.000.000 VNĐ", duration: "3.5 tháng", description: "Nội dung chính:\n- Mô đun 1 - Chi tiết máy: Cung cấp kiến thức nền tảng, cốt lõi về cấu tạo, nguyên lý làm việc và phương pháp kiểm tra, đánh giá hư hỏng của các chi tiết, cụm chi tiết máy cơ bản trên ô tô.\n- Mô đun 2 - Nhiên liệu và vật liệu bôi trơn: Trang bị kiến thức chuyên sâu về các loại xăng, dầu diesel, dầu mỡ bôi trơn và dầu truyền động, giúp học viên hiểu đúng và sử dụng đúng các loại vật liệu cho từng hệ thống trên xe.\n- Mô đun 3 - Sửa chữa và bảo dưỡng ô tô tải (Lý thuyết): Đi sâu vào cấu tạo, nguyên lý hoạt động, các hư hỏng thường gặp và quy trình sửa chữa của các hệ thống chính: Động cơ, hệ thống lái, truyền động, phanh, khung gầm và hệ thống điện.\n- Mô đun 4 - Thực hành sửa chữa: Học viên được trực tiếp \"bắt bệnh\" và thực hành tháo lắp, kiểm tra, sửa chữa, bảo dưỡng trên các bộ phận thực tế của ô tô như động cơ, hộp số, cầu xe....", benefits: "Sau khi tốt nghiệp, bạn sẽ có khả năng:\n- Chẩn đoán (\"bắt bệnh\") chính xác các hư hỏng thường gặp và thực hiện thành thạo quy trình tháo lắp, sửa chữa, bảo dưỡng các hệ thống chính trên ô tô (động cơ, khung gầm, hệ thống truyền lực, hệ thống điện...).\n- Sử dụng thành thạo các dụng cụ, thiết bị đo kiểm và sửa chữa chuyên dụng, đồng thời tuân thủ nghiêm ngặt các quy trình về an toàn lao động.\n- Tự tin làm việc tại các garage, xưởng dịch vụ, trạm bảo dưỡng của các hãng xe hoặc có đủ năng lực để tự mở xưởng sửa chữa ô tô của riêng mình." },
            "BD01": { name: "Nghiệp vụ điều hành và chỉ đạo sản xuất", fee: "8.000.000 VNĐ", duration: "2 tháng", description: "Khóa học nâng cao dành cho các tổ trưởng, đội trưởng, cán bộ quản lý. Cung cấp kỹ năng lập kế hoạch sản xuất, phân công công việc, giám sát, xử lý tình huống và quản lý con người tại hiện trường.", benefits: "- Nâng cao năng lực quản lý, tạo bước đệm thăng tiến.\n- Học hỏi kinh nghiệm từ các nhà quản lý cảng kỳ cựu.\n- Cấp chứng chỉ đào tạo đã hoàn thành chương trình bồi dưỡng nghiệp vụ." },
            "BD02": { name: "Bồi dưỡng tiếng Anh (điều hành sản xuất, giao nhận, khai thác cảng)", fee: "5.000.000 VNĐ", duration: "1 tháng", description: "Tập trung vào từ vựng, mẫu câu giao tiếp chuyên ngành cảng biển, logistics, xuất nhập khẩu. Giúp học viên tự tin giao tiếp với đối tác, thuyền viên và xử lý các chứng từ bằng tiếng Anh.", benefits: "- Nâng cao lợi thế cạnh tranh trong công việc.\n- Giáo trình được biên soạn riêng cho ngành.\n- Môi trường học tập tương tác cao với giáo viên bản ngữ/chuyên ngành." },
            "BD03": { name: "Bốc xếp hàng hóa", fee: "2.000.000 VNĐ", duration: "10 ngày", description: "Huấn luyện các kỹ thuật bốc xếp hàng hóa đúng cách, an toàn, đặc biệt là với các loại hàng nặng, hàng dễ vỡ. Sử dụng các công cụ hỗ trợ và tuân thủ quy trình an toàn lao động.", benefits: "- Khóa học ngắn hạn, chi phí thấp.\n- Nâng cao ý thức an toàn, phòng tránh tai nạn lao động.\n- Cần thiết cho mọi công nhân làm việc tại kho bãi, cảng." },
            "BD04": { name: "Nghiệp vụ chấm Bay", fee: "2.000.000 VNĐ", duration: "15 ngày", description: "Đào tạo nghiệp vụ lập sơ đồ hầm tàu (Bay Plan), tính toán, sắp xếp container trên tàu để đảm bảo an toàn, tối ưu tải trọng và thuận tiện cho việc dỡ hàng tại các cảng kế tiếp.", benefits: "- Cung cấp kiến thức chuyên môn sâu về khai thác tàu container.\n- Là kỹ năng quan trọng cho nhân viên kế hoạch, hiện trường cảng.\n- Cấp chứng chỉ đào tạo đã hoàn thành khóa học." },
            "BD05": { name: "Buộc cởi dây tàu", fee: "2.000.000 VNĐ", duration: "10 ngày", description: "Huấn luyện các kỹ thuật và quy trình buộc, cởi dây cho tàu thuyền khi cập và rời cầu cảng một cách an toàn, đúng tiêu chuẩn kỹ thuật hàng hải.", benefits: "- Đảm bảo an toàn cho người, phương tiện và công trình cảng.\n- Khóa học bắt buộc đối với công nhân làm nhiệm vụ buộc cởi dây.\n- Cấp chứng chỉ nghiệp vụ." },
            "BD06": { name: "Bồi dưỡng nghiệp vụ giao nhận hàng hóa (Nâng cao)", fee: "3.000.000 VNĐ", duration: "1 tháng", description: "Dành cho những người đã có kiến thức cơ bản, khóa học đi sâu vào các vấn đề phức tạp hơn như vận tải đa phương thức, hàng dự án, khiếu nại và bảo hiểm hàng hóa, cập nhật các quy định mới.", benefits: "- Nâng cao chuyên môn, giải quyết các tình huống phức tạp.\n- Mở rộng cơ hội nghề nghiệp ở các vị trí cao hơn.\n- Cập nhật kiến thức và thông lệ quốc tế." },
            "BD07": { name: "Nghiệp vụ giám định, sửa chữa Container (tiêu chuẩn IICL)", fee: "4.500.000 VNĐ", duration: "1 tháng", description: "Đào tạo học viên cách kiểm tra, đánh giá tình trạng container theo tiêu chuẩn quốc tế IICL, xác định các hư hỏng và đưa ra phương án sửa chữa phù hợp, lập báo cáo giám định.", benefits: "- Đào tạo theo tiêu chuẩn được quốc tế công nhận.\n- Nhu cầu nhân lực cao tại các cảng, depot, hãng tàu.\n- Cấp chứng chỉ giám định container." },
            "NB01": { name: "Nhân viên Giao nhận hàng hóa, Công nhân Bốc xếp thủ công", fee: "1.500.000 VNĐ", duration: "15 ngày", description: "Chương trình nâng bậc tay nghề cho các nhân viên giao nhận và công nhân bốc xếp, cập nhật các quy trình mới, kỹ năng làm việc hiệu quả và an toàn hơn.", benefits: "- Đáp ứng yêu cầu nâng bậc lương, bậc thợ của doanh nghiệp.\n- Củng cố và hệ thống hóa lại kiến thức, kỹ năng.\n- Thời gian học linh hoạt, không ảnh hưởng nhiều đến công việc." },
            "NB02": { name: "Công nhân vận hành (cần trục, lái xe), thợ kỹ thuật (sửa chữa, điện, sắt, hàn...)", fee: "2.000.000 VNĐ", duration: "15 ngày", description: "Khóa học nâng bậc dành cho công nhân vận hành thiết bị và thợ kỹ thuật, tập trung vào các kỹ năng xử lý sự cố phức tạp, bảo trì nâng cao và các công nghệ mới được áp dụng.", benefits: "- Nâng cao tay nghề, tăng khả năng cạnh tranh.\n- Điều kiện cần để xét duyệt nâng bậc lương tại doanh nghiệp.\n- Được ôn luyện và thi cấp chứng chỉ bậc thợ cao hơn." },
            "AT01": { name: "Huấn luyện ATVSLĐ Nhóm 1 (Người quản lý)", fee: "Lần đầu 500.000 VNĐ, định kỳ 250.000 VNĐ", duration: "2 ngày/16h", description: "Cung cấp kiến thức tổng quan về chính sách, pháp luật ATVSLĐ và kỹ năng tổ chức, quản lý, thực hiện công tác ATVSLĐ tại doanh nghiệp cho cán bộ quản lý, giám đốc.", benefits: "- Đáp ứng quy định bắt buộc của pháp luật (Nghị định 44/2016/NĐ-CP).\n- Nâng cao năng lực quản lý rủi ro về an toàn.\n- Cấp chứng nhận huấn luyện sau khóa học." },
            "AT02": { name: "Huấn luyện ATVSLĐ Nhóm 2 (Người làm công tác ATVSLĐ)", fee: "Lần đầu 500.000 VNĐ, định kỳ 250.000 VNĐ", duration: "6 ngày/48h", description: "Đào tạo chuyên sâu về nghiệp vụ ATVSLĐ cho cán bộ chuyên trách, bao gồm xây dựng hệ thống quản lý, nhận diện mối nguy, đánh giá rủi ro, điều tra tai nạn lao động.", benefits: "- Trang bị đầy đủ kiến thức và kỹ năng cho cán bộ an toàn.\n- Đáp ứng quy định của pháp luật.\n- Cấp chứng chỉ huấn luyện ATVSLĐ." },
            "AT03": { name: "Huấn luyện ATVSLĐ Nhóm 3 (Người LĐ yêu cầu nghiêm ngặt)", fee: "Lần đầu 1.000.000 VNĐ, định kỳ 250.000 VNĐ", duration: "3 ngày/24h", description: "Dành cho người lao động làm các công việc có yêu cầu nghiêm ngặt về ATVSLĐ (vận hành thiết bị nâng, làm việc trên cao...). Tập trung vào các quy trình an toàn đặc thù của công việc.", benefits: "- Hiểu rõ các mối nguy và biện pháp phòng tránh trực tiếp liên quan đến công việc.\n- Tuân thủ quy định của pháp luật.\n- Cấp thẻ An toàn lao động sau khi hoàn thành." },
            "AT04": { name: "Huấn luyện ATVSLĐ Nhóm 4 (Người LĐ khác)", fee: "Lần đầu 300.000 VNĐ, định kỳ 100.000 VNĐ", duration: "2 ngày/16h", description: "Cung cấp kiến thức cơ bản về ATVSLĐ tại nơi làm việc, các quyền và nghĩa vụ, nhận biết các yếu tố nguy hiểm và kỹ năng xử lý tình huống khẩn cấp cơ bản.", benefits: "- Nâng cao nhận thức chung về an toàn cho toàn bộ người lao động.\n- Chi phí thấp, có thể tổ chức tại doanh nghiệp.\n- Cấp sổ theo dõi huấn luyện được pháp luật công nhận." },
            "AT05": { name: "Huấn luyện ATVSLĐ Nhóm 5 (Người làm công tác y tế)", fee: "Lần đầu 1.000.000 VNĐ, định kỳ 500.000 VNĐ", duration: "6 ngày/48h", description: "Đào tạo, cập nhật kiến thức về quản lý sức khỏe người lao động, bệnh nghề nghiệp, sơ cấp cứu, tổ chức khám sức khỏe định kỳ và quản lý hồ sơ y tế tại nơi làm việc.", benefits: "- Dành riêng cho cán bộ y tế tại doanh nghiệp.\n- Nội dung chuyên sâu, sát với thực tế công tác y tế lao động.\n- Cấp chứng chỉ huấn luyện theo quy định." },
            "AT06": { name: "Huấn luyện ATVSLĐ Nhóm 6 (An toàn, vệ sinh viên)", fee: "Lần đầu 500.000 VNĐ, định kỳ 250.000 VNĐ", duration: "2 ngày/16h", description: "Bồi dưỡng kỹ năng hoạt động cho mạng lưới an toàn vệ sinh viên tại cơ sở: phương pháp tuyên truyền, kiểm tra, đôn đốc và giám sát việc thực hiện ATVSLLĐ của mọi người.", benefits: "- Phát huy vai trò của mạng lưới an toàn viên tại cơ sở.\n- Góp phần xây dựng văn hóa an toàn trong doanh nghiệp.\n- Cấp chứng nhận huấn luyện." }
        };
        const courseCategories = {
            SO_CAP: { name: 'Đào tạo Sơ Cấp (Vận hành & Kỹ thuật)', ids: ['SC01', 'SC02', 'SC03', 'SC04', 'SC05', 'SC06', 'SC07', 'SC08', 'SC09', 'SC10', 'SC11', 'SC12'] },
            BOI_DUONG: { name: 'Bồi dưỡng & Nâng bậc', ids: ['BD01', 'BD02', 'BD03', 'BD04', 'BD05', 'BD06', 'BD07', 'NB01', 'NB02'] },
            AN_TOAN: { name: 'Huấn luyện An toàn lao động', ids: ['AT01', 'AT02', 'AT03', 'AT04', 'AT05', 'AT06'] }
        };
        const courseImageUrls = {
            "SC01": "https://i.postimg.cc/fbgX7CJK/thang-05b.jpg", "SC02": "https://i.postimg.cc/L88nyfd0/rk0a8648.jpg", "SC03": "https://i.postimg.cc/4dVdKQtn/canghoangdieu-7.jpg", "SC04": "https://i.postimg.cc/zvtPsBFN/image.png", "SC05": "https://i.postimg.cc/WbSZgysQ/image-1.png", "SC06": "https://i.postimg.cc/FRgzmfR2/image-6.png", "SC07": "https://i.postimg.cc/s29Fn51G/dji-0104-1.jpg", "SC08": "https://i.postimg.cc/XYCV4Z1Q/image-2.png", "SC09": "https://i.postimg.cc/25WFQxch/1656684255873-81.jpg", "SC10": "https://i.postimg.cc/1tkzppdn/1496713924-Cau-banh-lop-100-tan.jpg", "SC11": "https://i.postimg.cc/7hrxCqCS/image-4.png", "SC12": "https://i.postimg.cc/HkN1cTRj/image-3.png", "BD": "https://i.postimg.cc/76yv0DBM/1d4b55a2-0860-49cf-b4e7-f5fb3554e7da.jpg", "NB": "https://i.postimg.cc/76yv0DBM/1d4b55a2-0860-49cf-b4e7-f5fb3554e7da.jpg", "AT": "https://i.postimg.cc/76yv0DBM/1d4b55a2-0860-49cf-b4e7-f5fb3554e7da.jpg", "DEFAULT": "https://images.unsplash.com/photo-1577985051167-5d55a82510c6?q=80&w=870&auto=format&fit=crop"
        };
        
        const courseDetailsKnowledgeBase = JSON.stringify(courseList, null, 2);

        // --- System Instruction for Gemini ---
        const systemInstruction = `
# YOUR CORE MISSION:
You are a friendly and professional admissions consultant for HPTTS. Your goal is to provide helpful, detailed, and polite information to prospective students in Vietnamese, based ONLY on the knowledge provided.

# YOUR KNOWLEDGE BASE (KEY INFO):
* **Company:** Công ty Cổ phần Dịch vụ Kỹ thuật và Đào tạo Cảng Hải Phòng (HPTTS).
* **Admissions Contact:** Mr Hưng: 0904468575, Ms Thuỷ: 0989387936 or Phone: 0225.3822900.
* **Website:** https://htts.com.vn/
* **Online Forms:**
    * Sơ cấp: https://docs.google.com/forms/d/e/1FAIpQLSeBzzxiW3edez3R6txOgUR-02txWPcMg8aNDd-thR0xWmQn8w/viewform
    * Bồi dưỡng/Nâng bậc: https://forms.gle/xejqdxcxijSJUBZ69
* **Tuition Fee Reduction Policy:** 10% discount for former soldiers, students from poor households, and students enrolling in 2 courses simultaneously.

# CRITICAL INSTRUCTIONS:
* You MUST ONLY use information from the knowledge base provided. Do not invent information. If you don't know the answer, politely say that you don't have the information and will get back to them.
* **HANDLING COURSE DETAIL QUERIES (e.g., "chi tiết khóa học SC01"):**
    * When a user asks for details about a specific course using its ID, you MUST use the answer in COURSE_DETAILS_KNOWLEDGE_BASE.
    * Find the course by its ID in the JSON data.
    * Present the information in a clear, structured format using Markdown. The response MUST include these sections in this order: **Tên khóa học**, **Thời gian**, **Học phí**, **Nội dung chính**, and the final section describing the outcomes.
    * For the final section title: If the course ID starts with 'SC', the title MUST be: **Sau khi tốt nghiệp, bạn sẽ có khả năng:**. For all other courses, the title MUST be: **Sau khi hoàn thành khóa học/huấn luyện, bạn có khả năng:**
    * After providing details, you MUST offer quick replies for "Đăng ký khóa học này" and "Xem các khóa học khác".
* **HANDLING REGISTRATION & CONTACT QUERIES:** When a user asks for registration or contact info, you MUST present the following text and buttons: "Để đăng ký, bạn có hai lựa chọn ạ. **Đăng ký nhanh qua Chatbot (Khuyên dùng):** Tôi sẽ hỏi bạn một vài thông tin cơ bản và giúp bạn gửi thông tin đăng ký trực tiếp đến phòng tuyển sinh. Nếu chưa có đủ hồ sơ, bạn nên chọn cách này. **Điền Form Online:** Lưu ý quan trọng: Để hoàn tất form, bạn cần chuẩn bị sẵn các bản scan hoặc ảnh chụp của: CCCD, Giấy khám sức khỏe, và Sơ yếu lý lịch. Nếu đã có đủ giấy tờ, bạn hãy chọn form tương ứng bên dưới." followed by buttons for "Đăng ký nhanh qua Chatbot", "Form Sơ cấp", and "Form Bồi dưỡng/Nâng bậc". For the "Đăng ký nhanh qua Chatbot" button, use the action "start_registration" with an empty string for the value.

# MANDATORY JSON RESPONSE FORMAT:
When the user's query requires displaying a list of courses or offering choices, you MUST embed a SINGLE JSON block at the very end of your response.

**FORMAT 1: Show Course List**
\`\`\`json
{
  "action": "show_course_list",
  "filter": { "category": "SO_CAP" | "BOI_DUONG" | "AN_TOAN" | "ALL" }
}
\`\`\`

**FORMAT 2: Quick Replies / Actions**
\`\`\`json
{
  "type": "quick_replies",
  "buttons": [
    { "label": "Label Text", "action": "query" | "start_registration" | "open_form", "value": "Query text or Course ID or URL" }
  ]
}
\`\`\`

# COURSE_DETAILS_KNOWLEDGE_BASE:
${courseDetailsKnowledgeBase}
`;
        
        // --- Helper Functions ---
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        function scrollToBottom() {
            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });
        }
        
        function animateMessage(element) {
            requestAnimationFrame(() => {
                element.classList.add('message-enter');
                requestAnimationFrame(() => {
                    element.classList.add('message-enter-active');
                });
            });
        }
        
        function setUILoading(state) {
            isLoading = state;
            chatInput.disabled = state;
            sendButton.disabled = state;
            if(state) {
                sendButton.innerHTML = `<div class="w-6 h-6 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>`;
            } else {
                sendButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
                chatInput.focus();
            }
        }

        /**
         * NEW: Function to validate date of birth
         * @param {string} dobString - Date of birth in DD/MM/YYYY format
         * @returns {{isValid: boolean, isAdult: boolean, error?: string}}
         */
        function validateDob(dobString) {
            const match = dobString.match(/^(\d{1,2})[\\/|-](\d{1,2})[\\/|-](\d{4})$/);
            if (!match) {
                return { isValid: false, isAdult: false, error: "Định dạng ngày sinh không hợp lệ. Vui lòng nhập theo dạng DD/MM/YYYY (ví dụ: 25/12/1998)." };
            }

            const day = parseInt(match[1], 10);
            const month = parseInt(match[2], 10);
            const year = parseInt(match[3], 10);

            const date = new Date(year, month - 1, day);
            if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                return { isValid: false, isAdult: false, error: "Ngày sinh bạn cung cấp không tồn tại (ví dụ: 31/02/2000). Vui lòng kiểm tra lại." };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            if (date > today) {
                return { isValid: false, isAdult: false, error: "Ngày sinh không thể là một ngày trong tương lai. Vui lòng kiểm tra lại." };
            }

            let age = today.getFullYear() - date.getFullYear();
            const m = today.getMonth() - date.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < date.getDate())) {
                age--;
            }

            if (age < 18) {
                return { isValid: true, isAdult: false, error: "Cảm ơn bạn đã quan tâm. Tuy nhiên, do tính đặc thù của nghề nghiệp, trung tâm chỉ tuyển sinh các học viên từ đủ 18 tuổi trở lên và đảm bảo sức khỏe để học nghề." };
            }

            return { isValid: true, isAdult: true };
        }


        // --- Message Display Functions ---
        function displayUserMessage(text) {
            const messageHTML = `
                <div class="flex items-end gap-2 justify-end">
                    <div class="w-full max-w-lg">
                        <div class="px-4 py-3 rounded-xl shadow-md bg-blue-500 text-white rounded-br-none">
                            <p class="text-sm">${text}</p>
                        </div>
                         <p class="text-xs text-white/80 mt-1 mr-1 text-right">${getCurrentTime()}</p>
                    </div>
                </div>`;
            const el = document.createElement('div');
            el.innerHTML = messageHTML;
            messageContainer.appendChild(el);
            animateMessage(el);
            scrollToBottom();
        }

        function displayBotMessage(text, isActionResponse = false) {
             const messageHTML = `
                <div class="flex items-end gap-2 justify-start">
                    <img src="${HPTTS_LOGO_URL}" alt="Bot Avatar" class="w-8 h-8 rounded-full self-start flex-shrink-0 object-cover">
                    <div class="w-full max-w-lg">
                        <div class="px-4 py-3 rounded-xl shadow-md bg-white/95 backdrop-blur-sm text-gray-800 rounded-bl-none">
                            <div class="markdown-content text-sm">${marked.parse(text)}</div>
                        </div>
                         <p class="text-xs text-white/80 mt-1 ml-1">${getCurrentTime()}</p>
                    </div>
                </div>`;
            const el = document.createElement('div');
            el.innerHTML = messageHTML;
            messageContainer.appendChild(el);
            animateMessage(el);
            scrollToBottom();
        }

        function displayQuickReplies(buttons) {
            let buttonsHTML = '<div class="flex flex-wrap gap-2 mt-2 max-w-lg ml-10">';
            buttons.forEach(button => {
                buttonsHTML += `<button data-action="${button.action}" data-value="${button.value}" class="quick-reply-btn px-4 py-1.5 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors">${button.label}</button>`;
            });
            buttonsHTML += '</div>';
            const el = document.createElement('div');
            el.innerHTML = buttonsHTML;
            messageContainer.appendChild(el);
            animateMessage(el);
            scrollToBottom();
        }

        function displayCarousel(items) {
            let itemsHTML = '<div class="carousel max-w-full ml-10">';
            items.forEach(item => {
                const course = courseList[item.id];
                const imageUrlKey = Object.keys(courseImageUrls).find(key => item.id.startsWith(key)) || 'DEFAULT';
                const imageUrl = courseImageUrls[imageUrlKey];
                itemsHTML += `
                    <div class="carousel-item bg-white rounded-lg shadow-md overflow-hidden">
                        <img src="${imageUrl}" class="w-full h-32 object-cover" alt="${course.name}">
                        <div class="p-3">
                            <h3 class="font-bold text-sm">${item.id}: ${course.name}</h3>
                            <p class="text-xs text-gray-600 mt-1">Thời gian: ${course.duration}</p>
                            <p class="text-xs text-gray-600">Học phí: ${course.fee}</p>
                            <div class="mt-3 flex gap-2">
                                <button data-action="query" data-value="Chi tiết khóa học ${item.id}" class="w-full text-xs quick-reply-btn px-3 py-1.5 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Xem chi tiết</button>
                                <button data-action="start_registration" data-value="${item.id}" class="w-full text-xs quick-reply-btn px-3 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600">Đăng ký</button>
                            </div>
                        </div>
                    </div>`;
            });
            itemsHTML += '</div>';
            const el = document.createElement('div');
            el.innerHTML = itemsHTML;
            messageContainer.appendChild(el);
            animateMessage(el);
            scrollToBottom();
        }

        // --- Core Logic ---
        async function callGeminiAPI(history) {
            setUILoading(true);
            try {
                const payload = {
                    contents: history,
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    processBotResponse(text);
                } else {
                    displayBotMessage("Xin lỗi, tôi chưa hiểu ý bạn. Bạn có thể hỏi cách khác không ạ?");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayBotMessage("Xin lỗi, tôi đang gặp sự cố kỹ thuật. Vui lòng thử lại sau.");
            } finally {
                setUILoading(false);
            }
        }

        function processBotResponse(text) {
            const jsonRegex = /(?:```(?:json)?\s*\n?)?({[\s\S]+?})(?:\s*\n?```)?\s*$/;
            const match = text.match(jsonRegex);
            let mainText = text;
            let actionData = null;

            if (match) {
                try {
                    actionData = JSON.parse(match[1]);
                    mainText = text.substring(0, text.lastIndexOf(match[0])).trim();
                } catch (e) {
                    // Not valid JSON, treat as plain text
                }
            }
            
            if (mainText) {
                chatHistory.push({ role: 'model', parts: [{ text: mainText }] });
                displayBotMessage(mainText);
            }

            if (actionData) {
                handleAction(actionData.action, actionData);
            }
        }
        
        // --- Action & Flow Handlers ---
        function handleAction(action, data) {
            if (action === 'show_course_list') {
                const { filter } = data;
                const categoryIds = filter?.category && filter.category !== 'ALL' 
                    ? courseCategories[filter.category]?.ids 
                    : Object.keys(courseList);
                
                if (categoryIds && categoryIds.length > 0) {
                    const carouselItems = categoryIds.map(id => ({ id }));
                    displayCarousel(carouselItems);
                }
            } else if (action === 'start_registration') {
                const courseId = data.value || (data.buttons && data.buttons[0].value);
                // **LOGIC FIX:** Check if courseId is valid and exists in our list
                if (!courseId || !courseList[courseId]) {
                    displayBotMessage("Dạ, để đăng ký nhanh, bạn vui lòng chọn một khóa học cụ thể từ danh sách bên dưới trước nhé.");
                    handleAction('show_course_list', { filter: { category: 'ALL' } });
                    return;
                }
                const courseName = courseList[courseId]?.name;
                registrationData = { courseId, courseName };
                registrationStep = 'awaiting_name';
                displayBotMessage(`Rất tuyệt! Để đăng ký khóa học **${courseName}**, chúng ta hãy bắt đầu với một vài thông tin cơ bản nhé.\n\nĐầu tiên, bạn vui lòng nhập **họ và tên đầy đủ** của bạn vào ô chat bên dưới.`);
            } else if (action === 'open_form') {
                 const url = data.value || data.buttons[0].value;
                 window.open(url, '_blank');
                 // Do not display any message here, the action is self-explanatory
            } else if (data.type === 'quick_replies') {
                displayQuickReplies(data.buttons);
            }
        }

        async function handleRegistrationFlow(userInput) {
            let responseText = '';
            switch (registrationStep) {
                case 'awaiting_name':
                    registrationData.fullName = userInput;
                    registrationStep = 'awaiting_dob';
                    responseText = `Cảm ơn ${userInput}. Tiếp theo, bạn vui lòng cho mình biết ngày sinh của bạn (ví dụ: 25/12/1998) ạ.`;
                    break;
                case 'awaiting_dob':
                    const dobValidation = validateDob(userInput);
                    if (!dobValidation.isValid || !dobValidation.isAdult) {
                        responseText = dobValidation.error;
                        // Stay on the same step if validation fails
                    } else {
                        registrationData.dob = userInput;
                        registrationStep = 'awaiting_phone';
                        responseText = "Cảm ơn bạn. Cuối cùng, bạn cho mình xin số điện thoại để trung tâm liên hệ nhé.";
                    }
                    break;
                case 'awaiting_phone':
                     if (!userInput.match(/^(0[3|5|7|8|9])+([0-9]{8})\b/)) {
                        responseText = "Số điện thoại không hợp lệ. Vui lòng nhập SĐT di động gồm 10 chữ số.";
                     } else {
                        registrationData.phone = userInput;
                        registrationStep = 'confirming';
                        responseText = `Cảm ơn bạn! Vui lòng xác nhận lại thông tin đăng ký:\n\n- **Khóa học:** ${registrationData.courseName}\n- **Họ tên:** ${registrationData.fullName}\n- **Ngày sinh:** ${registrationData.dob}\n- **SĐT:** ${registrationData.phone}\n\nNếu đã chính xác, vui lòng nhấn "Gửi Đăng Ký".`;
                        displayBotMessage(responseText);
                        displayQuickReplies([
                            { label: "✅ Gửi Đăng Ký", action: "confirm_registration", value: "confirm" },
                            { label: "✏️ Nhập lại", action: "retry_registration", value: "retry" }
                        ]);
                        return;
                     }
                    break;
            }
            displayBotMessage(responseText);
        }

        async function submitRegistration() {
            setUILoading(true);
            displayBotMessage("Đang gửi thông tin, vui lòng chờ...");
            try {
                const formData = new FormData();
                Object.entries(registrationData).forEach(([key, value]) => formData.append(key, value));
                
                const response = await fetch(GOOGLE_SCRIPT_WEB_APP_URL, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.status === 'success') {
                    displayBotMessage("✅ Đăng ký thành công! Cảm ơn bạn. Thông tin của bạn đã được ghi nhận. Phòng tuyển sinh sẽ sớm liên hệ với bạn để xác nhận và hướng dẫn các bước tiếp theo.");
                } else {
                    throw new Error(result.message || 'Lỗi không xác định từ máy chủ.');
                }
            } catch (error) {
                console.error("Registration submission error:", error);
                displayBotMessage(`❌ Rất tiếc, đã có lỗi xảy ra. Vui lòng liên hệ trực tiếp Mr. Hưng (0904468575) hoặc Ms. Thuỷ (0989387936) để được hỗ trợ.\n\nLỗi: ${error.message}`);
            } finally {
                registrationStep = 'idle';
                registrationData = {};
                setUILoading(false);
            }
        }

        function handleSendMessage(messageText, isAction = false) {
            if (isLoading || !messageText.trim()) return;
            if (registrationStep === 'confirming' && !isAction) return;

            if (!isAction) {
                displayUserMessage(messageText);
            }
            
            chatInput.value = '';

            if (registrationStep !== 'idle') {
                handleRegistrationFlow(messageText);
            } else {
                chatHistory.push({ role: 'user', parts: [{ text: messageText }] });
                callGeminiAPI(chatHistory);
            }
        }
        
        function showInitialMessage() {
            const welcomeText = 'Dạ chào bạn, tôi là Trợ lý Tuyển sinh của Trung tâm đào tạo HPTTS. Tôi có thể giúp gì cho bạn?';
            const quickReplies = [
                { label: "Các nhóm khóa học", action: 'query', value: "Cho tôi xem các nhóm khóa học" },
                { label: "Tư vấn đăng ký", action: 'query', value: "Tư vấn thủ tục đăng ký học" },
                { label: "Thông tin liên hệ", action: 'query', value: "Cho tôi xin thông tin liên hệ" }
            ];
            chatHistory = [];
            displayBotMessage(welcomeText);
            displayQuickReplies(quickReplies);
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSendMessage(chatInput.value);
        });

        messageContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.quick-reply-btn');
            if (button && !button.disabled) {
                const action = button.dataset.action;
                const value = button.dataset.value;
                const label = button.textContent;

                const buttonGroup = button.parentElement;
                buttonGroup.querySelectorAll('.quick-reply-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                
                if (action !== 'open_form') {
                    displayUserMessage(label);
                }

                if (action === 'query') {
                    handleSendMessage(value, true);
                } else if (action === 'start_registration') {
                    handleAction(action, { value });
                } else if (action === 'confirm_registration') {
                    submitRegistration();
                } else if (action === 'retry_registration') {
                    registrationStep = 'idle';
                    handleAction('start_registration', { value: registrationData.courseId });
                } else if (action === 'open_form') {
                    handleAction(action, { value });
                }
            }
        });

        resetButton.addEventListener('click', () => {
            messageContainer.innerHTML = '';
            registrationStep = 'idle';
            registrationData = {};
            showInitialMessage();
        });

        // --- Initialization ---
        showInitialMessage();
    </script>
</body>
</html>
